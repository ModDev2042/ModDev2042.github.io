<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Planes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #111;
      --panel: #222;
      --panel-2: #333;
      --text: #eee;
      --accent: #0ff;
    }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }
    header {
      background: var(--panel);
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { margin: 0; font-size: 1.5rem; }
    .cart-button { cursor: pointer; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      padding: 1rem;
    }
    .card {
      background: var(--panel-2);
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }
    .card:hover { transform: scale(1.03); }
    .card canvas, .card img {
      width: 100%;
      height: 150px;
      object-fit: contain;
      border-radius: 4px;
      background: white;
    }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      flex-direction: column;
    }
    .overlay.active { display: flex; }
    .overlay-content {
      background: var(--panel);
      padding: 1rem;
      border-radius: 8px;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
    }
    .overlay canvas, .overlay img {
      max-width: 100%;
      max-height: 80vh;
      display: block;
      background: white;
    }
    .close-btn {
      cursor: pointer;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--accent);
      align-self: flex-end;
    }
    /* Cart Drawer */
    .cart-drawer {
      position: fixed;
      top: 0; right: -400px;
      width: 300px;
      height: 100%;
      background: var(--panel);
      box-shadow: -2px 0 8px rgba(0,0,0,0.6);
      transition: right 0.3s;
      z-index: 3000;
      display: flex;
      flex-direction: column;
    }
    .cart-drawer.active { right: 0; }
    .cart-header {
      padding: 1rem;
      font-weight: bold;
      border-bottom: 1px solid #444;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cart-items {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    .cart-item {
      padding: 8px;
      border-bottom: 1px solid #444;
      font-size: 0.95rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cart-item-controls {
      display: flex;
      gap: 4px;
    }
    .cart-item-controls button {
      background: var(--accent);
      border: none;
      color: #111;
      font-weight: bold;
      border-radius: 4px;
      padding: 2px 8px;
      cursor: pointer;
    }
    .cart-footer {
      padding: 1rem;
      border-top: 1px solid #444;
    }
    .checkout-btn {
      width: 100%;
      padding: 0.5rem;
      background: var(--accent);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h1>Plane Models</h1>
    <div class="cart-button" onclick="toggleCart()">ðŸ›’ (<span id="cart-count">0</span>)</div>
  </header>

  <div class="grid">
    <div class="card" data-type="image" data-src="plane1.png" data-name="Plane 1">
      <img src="plane1.png" alt="Plane 1"/>
      <p>Plane 1</p>
    </div>
    <div class="card" data-type="stl" data-src="plane2.stl" data-name="Plane 2">
      <canvas></canvas>
      <p>Plane 2</p>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="overlay-content">
      <span class="close-btn" onclick="closeOverlay()">âœ–</span>
      <div id="viewer-inner"></div>
      <button class="checkout-btn" onclick="addToCart(currentItemName)">Add to Cart</button>
    </div>
  </div>

  <div id="cartDrawer" class="cart-drawer" aria-hidden="true">
    <div class="cart-header">
      Your Cart
      <span class="close-cart" onclick="toggleCart()">âœ–</span>
    </div>
    <div class="cart-items" id="cartItems"></div>
    <div class="cart-footer">
      <button class="checkout-btn">Checkout (Prototype)</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/STLLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/OrbitControls.js"></script>

  <script>
    const overlay = document.getElementById("overlay");
    const viewerInner = document.getElementById("viewer-inner");
    let currentItemName = null;

    document.querySelectorAll(".card").forEach(card => {
      const type = card.dataset.type;
      const src = card.dataset.src;
      const name = card.dataset.name;

      if (type === "stl") initSTLPreview(card, src);

      card.addEventListener("click", () => {
        currentItemName = name;
        openOverlay(type, src);
      });
    });

    function openOverlay(type, src) {
      overlay.classList.add("active");
      viewerInner.innerHTML = "";
      if (type === "image") {
        const img = document.createElement("img");
        img.src = src;
        viewerInner.appendChild(img);
      } else if (type === "stl") {
        openSTLViewer(src);
      }
    }

    function closeOverlay() {
      overlay.classList.remove("active");
      viewerInner.innerHTML = "";
    }

    // ---- Cart ----
    const cartDrawer = document.getElementById("cartDrawer");
    const cartCount = document.getElementById("cart-count");
    const cartItemsEl = document.getElementById("cartItems");
    let cart = [];

    function toggleCart() {
      cartDrawer.classList.toggle("active");
      cartDrawer.setAttribute("aria-hidden", cartDrawer.classList.contains("active") ? "false" : "true");
    }

    function addToCart(name) {
      const item = cart.find(i => i.name === name);
      if (item) {
        item.qty++;
      } else {
        cart.push({ name, qty: 1 });
      }
      updateCartCount();
      renderCart();
    }

    function changeQty(name, delta) {
      const item = cart.find(i => i.name === name);
      if (!item) return;
      item.qty += delta;
      if (item.qty <= 0) {
        cart = cart.filter(i => i.name !== name);
      }
      updateCartCount();
      renderCart();
    }

    function updateCartCount() {
      const total = cart.reduce((sum, i) => sum + i.qty, 0);
      cartCount.textContent = total;
    }

    function renderCart() {
      cartItemsEl.innerHTML = "";
      cart.forEach((item) => {
        const div = document.createElement("div");
        div.className = "cart-item";
        div.innerHTML = `
          <span>${item.name} Ã— ${item.qty}</span>
          <div class="cart-item-controls">
            <button onclick="changeQty('${item.name}', -1)">â€“</button>
            <button onclick="changeQty('${item.name}', 1)">+</button>
          </div>
        `;
        cartItemsEl.appendChild(div);
      });
    }

    // ---- STL Thumbnail ----
    function initSTLPreview(card, src) {
      const canvas = card.querySelector("canvas");
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(60, 4/3, 0.1, 2000);
      const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, preserveDrawingBuffer: true });
      renderer.setClearColor(0xffffff, 1);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));

      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(5, 5, 5);
      scene.add(light);
      scene.add(new THREE.AmbientLight(0x404040));

      const loader = new THREE.STLLoader();
      loader.load(src, (geometry) => {
        const material = new THREE.MeshStandardMaterial({ color: 0x333333, metalness: 0.2, roughness: 0.8 });
        const mesh = new THREE.Mesh(geometry, material);
        geometry.center();
        scene.add(mesh);

        geometry.computeBoundingBox();
        const size = new THREE.Vector3();
        geometry.boundingBox.getSize(size);
        const maxDim = Math.max(size.x, size.y, size.z);
        const dist = maxDim * 2.5;
        camera.position.set(dist, dist, dist);
        camera.lookAt(0, 0, 0);

        function resizePreview() {
          const w = canvas.clientWidth;
          const h = canvas.clientHeight;
          if (w === 0 || h === 0) return;
          camera.aspect = w / h;
          camera.updateProjectionMatrix();
          renderer.setSize(w, h, false);
        }
        const ro = new ResizeObserver(resizePreview);
        ro.observe(canvas);
        resizePreview();

        function animate() {
          requestAnimationFrame(animate);
          mesh.rotation.y += 0.01;
          renderer.clear();
          renderer.render(scene, camera);
        }
        animate();
      });
    }

    // ---- STL Overlay Viewer ----
    function openSTLViewer(src) {
      const container = document.createElement("div");
      container.style.width = "100%";
      container.style.height = "100%";
      viewerInner.appendChild(container);

      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0xffffff);

      const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 5000);
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
      container.appendChild(renderer.domElement);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.1;
      controls.enablePan = false;
      controls.enableZoom = true;

      const hemi = new THREE.HemisphereLight(0xffffff, 0x888888, 1.0);
      scene.add(hemi);

      const loader = new THREE.STLLoader();
      loader.load(src, (geometry) => {
        const mat = new THREE.MeshStandardMaterial({ color: 0x333333, metalness: 0.2, roughness: 0.8 });
        const mesh = new THREE.Mesh(geometry, mat);
        geometry.center();
        scene.add(mesh);

        geometry.computeBoundingBox();
        const size = new THREE.Vector3();
        geometry.boundingBox.getSize(size);
        const maxDim = Math.max(size.x, size.y, size.z);
        const fov = camera.fov * (Math.PI / 180);
        let camZ = (maxDim / 2) / Math.tan(fov / 2);
        camZ *= 2;
        camera.position.set(camZ, camZ, camZ);
        controls.target.set(0, 0, 0);
        controls.update();

        onResize();
        animate();
      });

      function onResize() {
        const w = container.clientWidth;
        const h = container.clientHeight;
        if (w === 0 || h === 0) return;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h, false);
      }
      const ro = new ResizeObserver(onResize);
      ro.observe(container);
      window.addEventListener("resize", onResize);

      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
    }
  </script>
</body>
</html>
